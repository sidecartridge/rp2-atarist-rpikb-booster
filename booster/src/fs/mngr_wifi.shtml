<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:;base64,=">
    <title><!--#TITLEHDR--></title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .form-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .form-row label {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .helper-text {
            font-weight: 400;
            color: #555;
            font-size: 0.95rem;
            display: block;
            margin-top: 0.15rem;
        }

        .form-row input,
        .form-row select {
            padding: 0.5rem 0.65rem;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 1rem;
            width: auto;
            min-width: 180px;
            max-width: 320px;
            justify-self: end;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .form-actions button {
            border: 1px solid #0078e7;
            background: #0078e7;
            color: #fff;
            border-radius: 6px;
            padding: 0.65rem 1rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-actions button:last-of-type {
            background: #fff;
            color: #0078e7;
        }

        .form-actions button:hover {
            opacity: 0.92;
        }

        .password-field {
            display: flex;
            align-items: center;
            justify-self: end;
            gap: 0.15rem;
        }

        .password-field input {
            min-width: 180px;
            max-width: 320px;
        }

        .eye-toggle {
            border: none;
            background: transparent;
            color: #333;
            border-radius: 0;
            padding: 0.2rem;
            cursor: pointer;
            line-height: 0;
        }

        .eye-toggle:hover {
            background: transparent;
        }

        .eye-toggle svg {
            width: 1.05rem;
            height: 1.05rem;
            display: block;
            fill: currentColor;
        }

        @media (max-width: 700px) {
            .form-row {
                grid-template-columns: 1fr;
                align-items: flex-start;
            }

            .form-row input,
            .form-row select {
                justify-self: end;
                width: 100%;
                max-width: 100%;
            }

            .password-field {
                width: 100%;
                justify-content: flex-end;
            }

            .password-field input {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <h1><!--#TITLEHDR--></h1>
    </header>

    <nav class="nav-bar" aria-label="Breadcrumb">
        <ul class="nav-list">
            <li class="nav-item">
                <a class="nav-link" href="/mngr_home.shtml">Home</a>
            </li>
            <li class="nav-item active">
                <span class="nav-link" aria-current="page">Advanced Network Settings</span>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <section class="content" id="wifi-setup">
            <h2>Advanced Network Settings</h2>
            <p>Configure how the manager web interface connects to Wi-Fi.</p>
            <div class="banner banner-warning">
                <span class="banner-icon" aria-hidden="true">!</span>
                <span>This page provides advanced network settings. In Station mode, your Wi-Fi network must provide
                    DHCP. If connection setup fails, the device automatically falls back after 90 seconds to Access
                    Point mode using default network settings.</span>
            </div>
            <div class="banner banner-warning">
                <span class="banner-icon" aria-hidden="true">!</span>
                <span>Please click "Save settings" to persist any changes you make on this page.</span>
            </div>

            <div id="wifi-status" class="banner banner-info" role="status" style="display: none;"></div>

            <form id="wifi-config-form">
                <div class="form-row">
                    <label for="wifi-mode">
                        <strong>Connection mode</strong>
                        <div class="helper-text">- <strong>Access Point:</strong> connect to
                            <code>hostname-id</code> (where <code>id</code> is the microcontroller ID) using the
                            password and auth mode set below.</div>
                        <div class="helper-text">- <strong>Station:</strong> connect this device to the SSID/BSSID
                            below; it will request an IP address by DHCP and be reachable as
                            <code>hostname.local</code>. Password and auth mode are also taken from the fields below.</div>
                    </label>
                    <select id="wifi-mode" name="wifi-mode">
                        <option value="0">Access Point</option>
                        <option value="1">Station</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="wifi-hostname">
                        <strong>Host name</strong>
                        <div class="helper-text">Device hostname used by mDNS and local network naming.</div>
                    </label>
                    <input type="text" id="wifi-hostname" name="wifi-hostname" maxlength="64" autocomplete="off">
                </div>

                <div class="form-row sta-only">
                    <label for="wifi-ssid">
                        <strong>SSID</strong>
                        <div class="helper-text">Wi-Fi network name to join in STA mode, or a BSSID in
                            <code>xx:xx:xx:xx:xx:xx</code> format (useful for repeaters/mesh nodes).</div>
                    </label>
                    <input type="text" id="wifi-ssid" name="wifi-ssid" maxlength="63" autocomplete="off">
                </div>

                <div class="form-row">
                    <label for="wifi-password">
                        <strong>Password</strong>
                        <div class="helper-text">Wi-Fi password used by both AP and STA modes.</div>
                    </label>
                    <div class="password-field">
                        <input type="password" id="wifi-password" name="wifi-password" maxlength="63" autocomplete="off">
                        <button type="button" id="toggle-password-visibility" class="eye-toggle" aria-label="Show password" title="Show password"></button>
                    </div>
                </div>

                <div class="form-row">
                    <label for="wifi-auth">
                        <strong>Auth mode</strong>
                        <div class="helper-text">Authentication mode used by both AP and STA modes.</div>
                    </label>
                    <select id="wifi-auth" name="wifi-auth">
                        <option value="0">OPEN (no password)</option>
                        <option value="2">WPA-TKIP-PSK</option>
                        <option value="5">WPA2-AES-PSK</option>
                        <option value="8">WPA2-MIXED-PSK</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" id="save-wifi-config" class="btn">Save settings</button>
                    <button type="button" id="reset-wifi-config" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2026 GOODDATA LABS SLU. All rights reserved.</p>
    </footer>

    <script>
        (function () {
            var statusBox = document.getElementById("wifi-status");
            var wifiMode = document.getElementById("wifi-mode");
            var wifiHostname = document.getElementById("wifi-hostname");
            var wifiSsid = document.getElementById("wifi-ssid");
            var wifiPassword = document.getElementById("wifi-password");
            var togglePasswordVisibility = document.getElementById("toggle-password-visibility");
            var wifiAuth = document.getElementById("wifi-auth");
            var staOnlyRows = document.querySelectorAll(".sta-only");
            var eyeOpenSvg = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 5c-4.97 0-9.27 2.98-11 7 1.73 4.02 6.03 7 11 7s9.27-2.98 11-7c-1.73-4.02-6.03-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>';
            var eyeClosedSvg = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3.27 2L2 3.27l3 3A11.72 11.72 0 0 0 1 12c1.73 4.02 6.03 7 11 7 2.08 0 4.03-.52 5.73-1.43L20.73 21 22 19.73 3.27 2zM12 17c-2.76 0-5-2.24-5-5 0-.72.15-1.4.43-2.01l1.59 1.59A3 3 0 0 0 12 15c.52 0 1.02-.13 1.45-.36l1.59 1.59c-.92.49-1.97.77-3.04.77zM12 7c2.76 0 5 2.24 5 5 0 .66-.13 1.3-.37 1.88l3.07 3.07A11.58 11.58 0 0 0 23 12c-1.73-4.02-6.03-7-11-7-1.5 0-2.94.27-4.27.76l2.39 2.39C10.7 7.41 11.33 7 12 7z"/></svg>';

            var initialState = {
                mode: "<!--#WFIMODE-->".trim() || "0",
                hostname: "<!--#WFIHOST-->".trim() || "croissant",
                ssid: "<!--#WFISSID-->".trim() || "",
                password: "<!--#WFIPASS-->".trim() || "",
                auth: "<!--#WFIAUTH-->".trim() || "0"
            };
            var resetState = {
                mode: "0",
                hostname: "croissant",
                ssid: "",
                password: "sidecart",
                auth: "5"
            };

            function showStatus(kind, message) {
                statusBox.className = "banner " + (kind === "error" ? "banner-error" : "banner-success");
                statusBox.textContent = message;
                statusBox.style.display = "flex";
            }

            function clearStatus() {
                statusBox.style.display = "none";
                statusBox.textContent = "";
            }

            function updateVisibility() {
                var staMode = wifiMode.value === "1";
                staOnlyRows.forEach(function (row) {
                    row.style.display = staMode ? "grid" : "none";
                });
            }

            function applyState(state) {
                wifiMode.value = state.mode || "0";
                wifiHostname.value = state.hostname || "croissant";
                wifiSsid.value = state.ssid || "";
                wifiPassword.value = state.password || "";
                wifiAuth.value = state.auth || "0";
                setPasswordVisibility(false);
                updateVisibility();
            }

            function setPasswordVisibility(visible) {
                wifiPassword.type = visible ? "text" : "password";
                togglePasswordVisibility.innerHTML = visible ? eyeClosedSvg : eyeOpenSvg;
                togglePasswordVisibility.setAttribute("aria-label", visible ? "Hide password" : "Show password");
                togglePasswordVisibility.setAttribute("title", visible ? "Hide password" : "Show password");
            }

            function buildPayload() {
                return [
                    { name: "WIFI_MODE", type: "INT", value: wifiMode.value },
                    { name: "HOSTNAME", type: "STRING", value: wifiHostname.value.trim() },
                    { name: "WIFI_SSID", type: "STRING", value: wifiSsid.value.trim() },
                    { name: "WIFI_PASSWORD", type: "STRING", value: wifiPassword.value },
                    { name: "WIFI_AUTH", type: "INT", value: wifiAuth.value }
                ];
            }

            document.getElementById("save-wifi-config").addEventListener("click", function () {
                clearStatus();

                if (wifiMode.value === "1" && wifiSsid.value.trim().length === 0) {
                    showStatus("error", "SSID is required when STA mode is selected.");
                    return;
                }

                if (wifiHostname.value.trim().length === 0) {
                    showStatus("error", "Hostname cannot be empty.");
                    return;
                }

                var payload = buildPayload();
                var encoded = btoa(JSON.stringify(payload));
                fetch("/saveparams.cgi?json=" + encodeURIComponent(encoded))
                    .then(function (response) { return response.text(); })
                    .then(function (text) {
                        try {
                            var data = JSON.parse(text);
                            if (data.status === 200) {
                                initialState.mode = wifiMode.value;
                                initialState.hostname = wifiHostname.value.trim();
                                initialState.ssid = wifiSsid.value.trim();
                                initialState.password = wifiPassword.value;
                                initialState.auth = wifiAuth.value;
                                showStatus("success", "Wi-Fi settings saved successfully. The new values will be used after a power cycle in the computer.");
                            } else {
                                showStatus("error", data.message || "Unable to save Wi-Fi settings.");
                            }
                        } catch (e) {
                            showStatus("error", "Unexpected response from the device.");
                        }
                    })
                    .catch(function () {
                        showStatus("error", "Network error while saving settings.");
                    });
            });

            document.getElementById("reset-wifi-config").addEventListener("click", function () {
                applyState(resetState);
                clearStatus();
            });

            wifiMode.addEventListener("change", function () {
                updateVisibility();
            });

            togglePasswordVisibility.addEventListener("click", function () {
                setPasswordVisibility(wifiPassword.type === "password");
            });

            setPasswordVisibility(false);
            applyState(initialState);
        })();
    </script>
</body>

</html>
